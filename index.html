<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart Plant Pot</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
<style>
  body{font-family:sans-serif; 
    background: linear-gradient(to right, #649173,#DBD5A4);
    background-attachment: fixed;
    color:#e5e7eb;
    margin:0
    }
  
  header{padding:1rem;text-align:center;font-weight:700}
  .grid{display:grid;gap:1rem;padding:1rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .card{background:transparent;padding:1rem;border-radius:12px}
  .val{font-size:2rem;font-weight:bold}
  button{margin:.5rem;padding:.5rem 1rem;border-radius:8px;background:#32aadd;color:#e5e7eb;border:none}

  .gauges {
    display:flex;
    gap:2rem;
    justify-content:center;
    flex-wrap:wrap; /* stack on small screens */
    margin:1rem;
  }
  canvas {
    background:transparent;
    border-radius:12px;
    padding:0.5rem;
  }
  .gauge-title{ text-align:center; font-weight:bold; margin:0 0 .5rem 0; }

  /* .actions{
  margin:1rem;
  margin-left:auto;        
  width:max-content;       
  display:flex;
  flex-direction:column;   
  gap:.5rem;
  align-items:flex-end;    
}
.actions button{ display:block; } */

</style>
</head>
<body>
<header>ðŸŒ± Smart Plant Pot Dashboard</header>

<div class="grid">
  <div class="card">Temp sensor: <span id="temp" class="val">--</span> Â°C</div>
  <div class="card">Hum sensor: <span id="hum" class="val">--</span> %</div>
  <div class="card">Soil sensor: <span id="soil" class="val">--</span></div>
  <div class="card">Light sensor: <span id="light" class="val">--</span></div>
</div>

<!-- class="actions"  -->
<div style="text-align:center;margin:1rem">
  <button onclick="pump('ON')">ðŸ’§ Water ON</button>
  <button onclick="pump('OFF')">âœ– Water OFF</button>
  <button onclick="enableNotifs()">ðŸ”” Enable notifications</button>
  <button onclick="downloadCSV()">â¬‡ Export CSV</button>
  <!-- <button onclick="testNotif()">Test notification -->
</div>


<!-- <script>
function testNotif(){ notify("Test", "It works"); }
</script> -->

<!-- <canvas id="chart" height="120"></canvas> -->
<div class="gauges">
<div>
  <p class="gauge-title">Temperature</p>
<canvas id="tempGauge"
    data-type="linear-gauge"
    data-width="120"
    data-height="400"
    data-units="Â°C"
    data-min-value="0"
    data-max-value="40"
    data-major-ticks="0,5,10,15,20,25,30,35,40"
    data-value="20"
    data-value-int="2"
    data-value-dec="1"
    data-borders="false"
    background: transparent;
    data-border-shadow-width="0"
    data-color-bar-progress="red"
    data-color-bar="rgba(255,255,255,0.2)"
    ></canvas>
</div>
<div>
  <p class="gauge-title">Soil Moisture</p>
<canvas id="soilGauge"
    data-type="linear-gauge"
    data-width="120"
    data-height="400"
    data-units="Soil moisture"
    data-min-value="0"
    data-max-value="100"
    data-major-ticks=" "
    data-tick-side="none"
    data-number-side="none"
    data-units="% Soil moisture" 
    data-value-int="2"
    data-value-dec="0"
    data-borders="false"
    background: transparent;
    data-border-shadow-width="0"
    data-color-bar-progress="blue"
    data-color-bar="rgba(56, 210, 224,0.2)"
></canvas>
</div>

<div>
  <p class="gauge-title">Light</p>
  <canvas id="lightGauge"
  data-type="radial-gauge"
  data-width="220"
  data-height="220"
  data-units="% Light"
  data-min-value="0" data-max-value="100"
  data-major-ticks="0,20,40,60,80,100"
  data-minor-ticks="2"
  data-value-box="true"
  data-value-int="3"
   data-value-dec="0"
  data-borders="false" 
  data-border-shadow-width="0"
  background: transparent;
  data-color-plate="#f0f0f0"
  data-color-bar="rgba(255,255,255,0.15)"
  data-color-bar-progress="#eab308"
  data-highlights='[
    {"from":0,"to":20,"color":"rgba(184,184,169,5)"},
    {"from":20,"to":70,"color":"rgba(255,255,125,5)"},
    {"from":70,"to":100,"color":"rgba(250,250,7,5)"}]'
    data-value="0"
    data-color-plate="transparent"
    data-color-bar="rgba(255,255,255,.12)"
></canvas>
  <!-- <p id="lightLabel" style="text-align:center;font-size:1.2rem;font-weight:bold"></p> -->
</div>
</div>


<script src="https://cdn.jsdelivr.net/npm/canvas-gauges/gauge.min.js"></script>


<script>
const MQTT_HOST="4629ff2d3b384c748f95b499f10e4f5b.s1.eu.hivemq.cloud";
const MQTT_USER="hivemq.webclient.1755195003530"; // read+write restricted
const MQTT_PASS="8354ECQbTRgAeafh:%!$"; 
const TOPIC_SENS="plantpot/sensors";
const TOPIC_PUMP="plantpot/pump";
const TOPIC_STATUS = "plantpot/hivemq.webclient.1755195003530/status";
const TOPIC_PUMP_ACK = "plantpot/hivemq.webclient.1755195003530/pump/ack";

function lightLabelToPercent(lbl){
  if (!lbl) return null;
  lbl = String(lbl).toLowerCase();
  if (lbl.includes("sensor")) return null;
  if (lbl.includes("very bright")) return 100;
  if (lbl.includes("bright"))      return 85;
  if (lbl.includes("light"))       return 65;
  if (lbl.includes("dim"))         return 35;
  if (lbl.includes("dark"))        return 10;
  return null;
}

async function enableNotifs(){
  if(!("Notification" in window)) { alert("Notifications not supported"); return; }
  const perm = await Notification.requestPermission();
  console.log("Notif permission:", perm);
  if (perm === "granted") new Notification("Enabled", { body:"You will get alerts.", silent:true });
}

function notify(title, body){
  if (!("Notification" in window)) { console.log("No Notification API"); return; }
  if (Notification.permission !== "granted") { console.log("Permission:", Notification.permission); return; }
  new Notification(title, { body });
}

// simple throttle so you donâ€™t get spammed
const _last = {};
function shouldNotify(key, ms=3000){
  const now = Date.now();
  if (_last[key] && now - _last[key] < ms) return false;
  _last[key] = now; return true;
}

const csvRows = [["ts","temp_c","humidity","soil_pct","light_pct","moistureValue"]];
function logRow(d){
  const ts = new Date().toISOString();
  csvRows.push([ts, d.temp_c ?? "", d.humidity ?? "", d.soil_pct ?? "", d.light_pct ?? "", d.moistureValue ?? ""]);
}
function downloadCSV(){
  const csv = csvRows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "plantpot_log.csv"; a.click();
  URL.revokeObjectURL(url);
}


const client=mqtt.connect(`wss://${MQTT_HOST}:8884/mqtt`,{
  username:MQTT_USER,password:MQTT_PASS,clean:true,reconnectPeriod:2000
});

client.on("connect", ()=>{
  client.subscribe([TOPIC_SENS, TOPIC_STATUS, TOPIC_PUMP_ACK]);
});


client.on("message",(t,m)=>{

  let d;
  try { d = JSON.parse(m.toString()); } catch { return; }

    if (t === TOPIC_SENS) logRow(d);

    if (t === TOPIC_STATUS) {
    console.log("status:", m.toString());
    notify("Ð¡Ñ‚Ð°Ñ‚ÑƒÑ", m.toString()); // Notifications API (Application Programming Interface)
    return;
  }
  if (t === TOPIC_PUMP_ACK) {
    try {
      const a = JSON.parse(m.toString());
      notify("ÐŸÐ¾Ð¼Ð¿Ð° ACK", `${a.cmd} â†’ ${a.result}`);
    } catch {
      notify("ÐŸÐ¾Ð¼Ð¿Ð° ACK", m.toString());
    }
    return;
  }

  // --- LIGHT update ---
  const gLight = document.gauges?.get('lightGauge');
  if (gLight){
    let pct = null;

    // 1) if you publish label strings:
    pct = lightLabelToPercent(d.lightValue);

    // 2) else if you publish RAW ADC (0..4095, higher = darker in your thresholds):
    if (pct==null && Number.isFinite(Number(d.light_raw||d.lightValue))){
      const raw = Number(d.light_raw||d.lightValue);
      const clipped = Math.max(0, Math.min(4095, raw));
      pct = Math.round(100 - (clipped/4095)*100); // invert so brighter => higher %
    }

    if (pct != null) {
    gLight.value = pct;
    gLight.update({ units: d.lightValue ?? "% Light" });
    }
  }


  // let d=JSON.parse(m.toString());
  document.getElementById("temp").textContent = (d.temp_c ?? "--");
  document.getElementById("hum").textContent=d.humidity??"--";
  document.getElementById("soil").textContent=d.moistureValue??"--";
  document.getElementById("light").textContent=d.lightValue??"--";
  // document.getElementById("lightLabel").textContent = d.lightValue ?? "--";
  const ll = document.getElementById("lightLabel");
  if (ll) ll.textContent = d.lightValue ?? "--";
  
    const gTemp = document.gauges?.get('tempGauge');
  if (gTemp && Number.isFinite(Number(d.temp_c))) {
    gTemp.value = Number(d.temp_c);
    gTemp.update({ units: d.temp_c ? d.temp_c + " Â°C" : "Â°C" });
  }

  const gSoil = document.gauges?.get('soilGauge');
if (gSoil) {
  // numeric percent if you send it; else map from text
  let pct = Number.isFinite(Number(d.soil_pct)) ? Number(d.soil_pct) : null;
  if (pct == null) {
    if (d.moistureValue === "Very Wet") pct = 100;
    else if (d.moistureValue === "Wet") pct = 80;
    else if (d.moistureValue === "Moist") pct = 60;
    else if (d.moistureValue === "Dry") pct = 40;
    else if (d.moistureValue === "Very Dry") pct = 20;
  }
  if (pct != null) gSoil.value = pct;

  // dynamic units show the label text
  gSoil.update({ units: d.moistureValue ?? "% Soil moisture" });
}
  console.log("soil:", d.moistureValue, "soil_pct:", d.soil_pct, "soil_raw:", d.soil_raw ?? d.soil ?? d.soil_adc);

  const mv = String(d.moistureValue || "").toLowerCase();
  const dryLabel = mv.includes("dry");                 // matches "dry" and "very dry"

  const pct = Number(d.soil_pct);
  const dryPct = Number.isFinite(pct) && pct <= 25;    // loosen threshold

  const raw = Number(d.soil_raw ?? d.soil ?? d.soil_adc);
  const dryRaw = Number.isFinite(raw) && raw >= 3000;  // adjust to your mapping

  if ((dryLabel || dryPct || dryRaw) && shouldNotify("dry")) {
    notify("Soil is dry", d.moistureValue ?? (Number.isFinite(pct) ? `${pct}%` : `raw ${raw}`));
  }

});


function pump(cmd){ client.publish(TOPIC_PUMP,cmd); }

// // Chart.js
// const ctx=document.getElementById("chart");
// const chart=new Chart(ctx,{type:"line",data:{labels:[],datasets:[{label:"Temp Â°C",data:[],borderColor:"red"}]},options:{scales:{x:{display:false}}}});
// function addPoint(v){if(!v)return;const t=new Date().toLocaleTimeString();chart.data.labels.push(t);chart.data.datasets[0].data.push(v);if(chart.data.labels.length>20){chart.data.labels.shift();chart.data.datasets[0].data.shift();}chart.update();}
</script>
</body>
</html>
